<!doctype html>
<html lang="th" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Virtual Fabric Dyeing Simulation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Thai:wght@400;500;600;700&amp;family=Space+Grotesk:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    * {
      font-family: 'Space Grotesk', 'IBM Plex Sans Thai', sans-serif;
    }
    .slider-track {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      border-radius: 4px;
      outline: none;
    }
    .slider-track::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    }
    .slider-L::-webkit-slider-thumb { background: #0ea5e9; }
    .slider-a::-webkit-slider-thumb { background: #0ea5e9; }
    .slider-b::-webkit-slider-thumb { background: #0ea5e9; }
    .compare-slider {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 4px;
      background: white;
      cursor: ew-resize;
      box-shadow: 0 0 10px rgba(0,0,0,0.5);
    }
    .compare-handle {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 40px;
      height: 40px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .zoom-container {
      overflow: auto;
      cursor: grab;
    }
    .zoom-container:active {
      cursor: grabbing;
    }
    .industrial-pattern {
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0f9ff 100%);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-slate-900 text-slate-100 overflow-auto">
  <div id="app-wrapper" class="min-h-full w-full industrial-pattern"><!-- Header -->
   <header class="bg-gradient-to-r from-white via-sky-50 to-white border-b-4 border-sky-400 shadow-lg shadow-sky-200">
    <div class="max-w-7xl mx-auto px-4 py-6">
     <div class="flex items-center gap-4">
      <div class="w-12 h-12 bg-sky-500 rounded-lg flex items-center justify-center shadow-md">
       <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
       </svg>
      </div>
      <div>
       <h1 id="main-title" class="text-2xl md:text-3xl font-bold text-sky-900">Virtual Fabric Dyeing Simulation</h1>
       <p id="subtitle" class="text-sky-600 text-sm md:text-base">Simulate dyeing result using ΔL* Δa* Δb* from color calculation system</p>
      </div>
     </div>
    </div>
   </header>
   <main class="max-w-7xl mx-auto px-4 py-6 space-y-6"><!-- Upload & Controls Section -->
    <div class="grid lg:grid-cols-3 gap-6"><!-- Upload Panel -->
     <div class="bg-white rounded-xl border border-sky-200 shadow-lg p-5">
      <h2 class="text-lg font-semibold text-sky-700 mb-4 flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
       </svg> Upload Fabric Image</h2><label id="upload-zone" class="block border-2 border-dashed border-sky-300 rounded-lg p-8 text-center cursor-pointer hover:border-sky-500 hover:bg-sky-50 transition-all duration-300"> <input type="file" id="image-input" accept="image/*" class="hidden">
       <svg class="w-12 h-12 mx-auto text-sky-400 mb-3" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
       </svg><p class="text-sky-600 text-sm">Click or drag image here</p><p class="text-sky-500 text-xs mt-1">PNG, JPG up to 10MB</p></label>
      <p id="file-name" class="text-sky-600 text-sm mt-3 truncate hidden"></p>
     </div><!-- Delta Controls -->
     <div class="lg:col-span-2 bg-white rounded-xl border border-sky-200 shadow-lg p-5">
      <h2 class="text-lg font-semibold text-sky-700 mb-4 flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
       </svg> Color Adjustment (CIELAB Delta Values)</h2>
      <div class="grid md:grid-cols-3 gap-6"><!-- ΔL* Slider -->
       <div class="space-y-2">
        <div class="flex justify-between items-center"><label class="text-sky-800 font-medium">ΔL* (Lightness)</label> <span id="deltaL-value" class="text-sky-700 font-mono bg-sky-50 px-2 py-1 rounded text-sm border border-sky-200">0.00</span>
        </div><input type="range" id="deltaL" min="-50" max="50" step="0.1" value="0" class="w-full slider-track bg-gradient-to-r from-gray-900 via-gray-400 to-white slider-L">
        <div class="flex justify-between text-xs text-sky-600"><span>Darker</span> <span>Lighter</span>
        </div>
       </div><!-- Δa* Slider -->
       <div class="space-y-2">
        <div class="flex justify-between items-center"><label class="text-sky-800 font-medium">Δa* (Green-Red)</label> <span id="deltaa-value" class="text-sky-700 font-mono bg-sky-50 px-2 py-1 rounded text-sm border border-sky-200">0.00</span>
        </div><input type="range" id="deltaa" min="-50" max="50" step="0.1" value="0" class="w-full slider-track bg-gradient-to-r from-green-600 via-gray-300 to-red-600 slider-a">
        <div class="flex justify-between text-xs text-sky-600"><span>Green</span> <span>Red</span>
        </div>
       </div><!-- Δb* Slider -->
       <div class="space-y-2">
        <div class="flex justify-between items-center"><label class="text-sky-800 font-medium">Δb* (Blue-Yellow)</label> <span id="deltab-value" class="text-sky-700 font-mono bg-sky-50 px-2 py-1 rounded text-sm border border-sky-200">0.00</span>
        </div><input type="range" id="deltab" min="-50" max="50" step="0.1" value="0" class="w-full slider-track bg-gradient-to-r from-blue-600 via-gray-300 to-yellow-500 slider-b">
        <div class="flex justify-between text-xs text-sky-600"><span>Blue</span> <span>Yellow</span>
        </div>
       </div>
      </div><!-- Manual Input -->
      <div class="mt-4 pt-4 border-t border-sky-200">
       <p class="text-sky-600 text-sm mb-3">Or enter values manually:</p>
       <div class="grid grid-cols-3 gap-4">
        <div><label class="text-xs text-sky-700">ΔL*</label> <input type="number" id="deltaL-input" step="0.01" value="0" class="w-full bg-white border border-sky-300 rounded px-3 py-2 text-sky-900 text-sm focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none">
        </div>
        <div><label class="text-xs text-sky-700">Δa*</label> <input type="number" id="deltaa-input" step="0.01" value="0" class="w-full bg-white border border-sky-300 rounded px-3 py-2 text-sky-900 text-sm focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none">
        </div>
        <div><label class="text-xs text-sky-700">Δb*</label> <input type="number" id="deltab-input" step="0.01" value="0" class="w-full bg-white border border-sky-300 rounded px-3 py-2 text-sky-900 text-sm focus:border-sky-500 focus:ring-1 focus:ring-sky-500 outline-none">
        </div>
       </div>
      </div>
     </div>
    </div><!-- Image Display Section -->
    <div class="bg-white rounded-xl border border-sky-200 shadow-lg p-5">
     <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
      <h2 class="text-lg font-semibold text-sky-700 flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /> <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
       </svg> Preview</h2>
      <div class="flex gap-2 flex-wrap"><button id="btn-compare" class="px-4 py-2 bg-sky-100 hover:bg-sky-200 text-sky-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm" disabled>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg> Compare </button> <button id="btn-zoom" class="px-4 py-2 bg-sky-100 hover:bg-sky-200 text-sky-700 rounded-lg text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm" disabled>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
        </svg> Zoom 100% </button> <button id="btn-reset" class="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2 shadow-md">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
        </svg> Reset </button> <button id="btn-export" class="px-4 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed shadow-md" disabled>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg> Export PNG </button>
      </div>
     </div><!-- Canvas Container -->
     <div id="canvas-container" class="grid md:grid-cols-2 gap-4"><!-- Original Image -->
      <div class="space-y-2">
       <h3 class="text-sm font-medium text-sky-700 text-center">Original Fabric (Before)</h3>
       <div class="bg-sky-50 rounded-lg overflow-hidden aspect-video flex items-center justify-center border border-sky-200">
        <canvas id="canvas-original" class="max-w-full max-h-full hidden"></canvas>
        <div id="placeholder-original" class="text-sky-300 text-center p-8">
         <svg class="w-16 h-16 mx-auto mb-3 text-sky-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
         </svg>
         <p class="text-sm">Upload image to start</p>
        </div>
       </div>
      </div><!-- Processed Image -->
      <div class="space-y-2">
       <h3 class="text-sm font-medium text-sky-700 text-center">Simulated Dyed Fabric (After)</h3>
       <div class="bg-sky-50 rounded-lg overflow-hidden aspect-video flex items-center justify-center border border-sky-200">
        <canvas id="canvas-processed" class="max-w-full max-h-full hidden"></canvas>
        <div id="placeholder-processed" class="text-sky-300 text-center p-8">
         <svg class="w-16 h-16 mx-auto mb-3 text-sky-300" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
         </svg>
         <p class="text-sm">Processed image will appear here</p>
        </div>
       </div>
      </div>
     </div><!-- Compare View (Hidden by default) -->
     <div id="compare-container" class="hidden mt-4">
      <div class="relative bg-sky-50 rounded-lg overflow-hidden aspect-video border border-sky-200">
       <canvas id="canvas-compare-before" class="absolute top-0 left-0 w-full h-full object-contain"></canvas>
       <canvas id="canvas-compare-after" class="absolute top-0 left-0 h-full object-contain" style="clip-path: inset(0 50% 0 0);"></canvas>
       <div id="compare-slider" class="compare-slider" style="left: 50%;">
        <div class="compare-handle">
         <svg class="w-5 h-5 text-slate-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
         </svg>
        </div>
       </div>
       <div class="absolute top-2 left-2 bg-black/70 px-2 py-1 rounded text-xs">
        Before
       </div>
       <div class="absolute top-2 right-2 bg-black/70 px-2 py-1 rounded text-xs">
        After
       </div>
      </div><button id="btn-close-compare" class="mt-3 px-4 py-2 bg-sky-100 hover:bg-sky-200 text-sky-700 rounded-lg text-sm font-medium transition-colors mx-auto block shadow-sm"> Close Compare View </button>
     </div><!-- Zoom View (Hidden by default) -->
     <div id="zoom-container" class="hidden mt-4">
      <div class="zoom-container bg-sky-50 rounded-lg border border-sky-200 h-96 relative">
       <canvas id="canvas-zoom" class="absolute top-0 left-0"></canvas>
      </div><button id="btn-close-zoom" class="mt-3 px-4 py-2 bg-sky-100 hover:bg-sky-200 text-sky-700 rounded-lg text-sm font-medium transition-colors mx-auto block shadow-sm"> Close Zoom View </button>
     </div>
    </div><!-- Statistics Section -->
    <div class="grid md:grid-cols-3 gap-4"><!-- Original LAB -->
     <div class="bg-white rounded-xl border border-sky-200 shadow-lg p-5">
      <h3 class="text-sm font-semibold text-sky-700 mb-3 flex items-center gap-2">
       <div class="w-3 h-3 bg-sky-400 rounded-full"></div> Original Average LAB</h3>
      <div class="space-y-2 font-mono text-sm">
       <div class="flex justify-between"><span class="text-sky-600">L*</span> <span id="stat-orig-L" class="text-sky-900">-</span>
       </div>
       <div class="flex justify-between"><span class="text-sky-600">a*</span> <span id="stat-orig-a" class="text-sky-900">-</span>
       </div>
       <div class="flex justify-between"><span class="text-sky-600">b*</span> <span id="stat-orig-b" class="text-sky-900">-</span>
       </div>
      </div>
     </div><!-- Processed LAB -->
     <div class="bg-white rounded-xl border border-sky-200 shadow-lg p-5">
      <h3 class="text-sm font-semibold text-sky-700 mb-3 flex items-center gap-2">
       <div class="w-3 h-3 bg-sky-500 rounded-full"></div> Simulated Average LAB</h3>
      <div class="space-y-2 font-mono text-sm">
       <div class="flex justify-between"><span class="text-sky-600">L*</span> <span id="stat-proc-L" class="text-sky-700 font-semibold">-</span>
       </div>
       <div class="flex justify-between"><span class="text-sky-600">a*</span> <span id="stat-proc-a" class="text-sky-700 font-semibold">-</span>
       </div>
       <div class="flex justify-between"><span class="text-sky-600">b*</span> <span id="stat-proc-b" class="text-sky-700 font-semibold">-</span>
       </div>
      </div>
     </div><!-- Delta E -->
     <div class="bg-white rounded-xl border border-sky-200 shadow-lg p-5">
      <h3 class="text-sm font-semibold text-sky-700 mb-3 flex items-center gap-2">
       <div class="w-3 h-3 bg-sky-600 rounded-full"></div> Color Difference (ΔE*ab)</h3>
      <div class="text-center py-2"><span id="stat-deltaE" class="text-4xl font-bold text-sky-600">-</span>
      </div>
      <div id="deltaE-interpretation" class="text-xs text-sky-600 text-center mt-2">
       -
      </div>
     </div>
    </div><!-- Processing Indicator -->
    <div id="processing-indicator" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
     <div class="bg-white rounded-xl p-8 text-center shadow-2xl">
      <div class="w-12 h-12 border-4 border-sky-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-sky-900">Processing image...</p>
     </div>
    </div>
   </main><!-- Footer -->
   <footer class="bg-white/50 backdrop-blur border-t border-sky-200 mt-8 py-4">
    <p class="text-center text-sky-600 text-sm">Virtual Fabric Dyeing Simulation • Color Science Lab Tool</p>
   </footer>
  </div>
  <script>
    // Default configuration
    const defaultConfig = {
      main_title: 'Virtual Fabric Dyeing Simulation',
      subtitle: 'Simulate dyeing result using ΔL* Δa* Δb* from color calculation system',
      primary_color: '#0ea5e9',
      background_color: '#f0f9ff',
      surface_color: '#ffffff',
      text_color: '#0c4a6e',
      accent_color: '#38bdf8'
    };

    let config = { ...defaultConfig };

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          applyConfig();
        },
        mapToCapabilities: (cfg) => ({
          recolorables: [
            {
              get: () => cfg.background_color || defaultConfig.background_color,
              set: (v) => { cfg.background_color = v; window.elementSdk.setConfig({ background_color: v }); }
            },
            {
              get: () => cfg.surface_color || defaultConfig.surface_color,
              set: (v) => { cfg.surface_color = v; window.elementSdk.setConfig({ surface_color: v }); }
            },
            {
              get: () => cfg.text_color || defaultConfig.text_color,
              set: (v) => { cfg.text_color = v; window.elementSdk.setConfig({ text_color: v }); }
            },
            {
              get: () => cfg.primary_color || defaultConfig.primary_color,
              set: (v) => { cfg.primary_color = v; window.elementSdk.setConfig({ primary_color: v }); }
            },
            {
              get: () => cfg.accent_color || defaultConfig.accent_color,
              set: (v) => { cfg.accent_color = v; window.elementSdk.setConfig({ accent_color: v }); }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['main_title', cfg.main_title || defaultConfig.main_title],
          ['subtitle', cfg.subtitle || defaultConfig.subtitle]
        ])
      });
    }

    function applyConfig() {
      document.getElementById('main-title').textContent = config.main_title || defaultConfig.main_title;
      document.getElementById('subtitle').textContent = config.subtitle || defaultConfig.subtitle;
    }

    // Color conversion functions
    function rgbToLab(r, g, b) {
      // RGB to XYZ
      let rn = r / 255;
      let gn = g / 255;
      let bn = b / 255;

      rn = rn > 0.04045 ? Math.pow((rn + 0.055) / 1.055, 2.4) : rn / 12.92;
      gn = gn > 0.04045 ? Math.pow((gn + 0.055) / 1.055, 2.4) : gn / 12.92;
      bn = bn > 0.04045 ? Math.pow((bn + 0.055) / 1.055, 2.4) : bn / 12.92;

      rn *= 100;
      gn *= 100;
      bn *= 100;

      const x = rn * 0.4124564 + gn * 0.3575761 + bn * 0.1804375;
      const y = rn * 0.2126729 + gn * 0.7151522 + bn * 0.0721750;
      const z = rn * 0.0193339 + gn * 0.1191920 + bn * 0.9503041;

      // XYZ to LAB (D65 illuminant)
      const xn = 95.047;
      const yn = 100.000;
      const zn = 108.883;

      let fx = x / xn;
      let fy = y / yn;
      let fz = z / zn;

      fx = fx > 0.008856 ? Math.pow(fx, 1/3) : (903.3 * fx + 16) / 116;
      fy = fy > 0.008856 ? Math.pow(fy, 1/3) : (903.3 * fy + 16) / 116;
      fz = fz > 0.008856 ? Math.pow(fz, 1/3) : (903.3 * fz + 16) / 116;

      const L = 116 * fy - 16;
      const a = 500 * (fx - fy);
      const bVal = 200 * (fy - fz);

      return { L, a, b: bVal };
    }

    function labToRgb(L, a, b) {
      // LAB to XYZ
      const fy = (L + 16) / 116;
      const fx = a / 500 + fy;
      const fz = fy - b / 200;

      const xn = 95.047;
      const yn = 100.000;
      const zn = 108.883;

      let x = fx > 0.206897 ? Math.pow(fx, 3) : (fx - 16/116) / 7.787;
      let y = fy > 0.206897 ? Math.pow(fy, 3) : (fy - 16/116) / 7.787;
      let z = fz > 0.206897 ? Math.pow(fz, 3) : (fz - 16/116) / 7.787;

      x *= xn;
      y *= yn;
      z *= zn;

      // XYZ to RGB
      let r = x * 3.2404542 + y * -1.5371385 + z * -0.4985314;
      let g = x * -0.9692660 + y * 1.8760108 + z * 0.0415560;
      let bVal = x * 0.0556434 + y * -0.2040259 + z * 1.0572252;

      r /= 100;
      g /= 100;
      bVal /= 100;

      r = r > 0.0031308 ? 1.055 * Math.pow(r, 1/2.4) - 0.055 : 12.92 * r;
      g = g > 0.0031308 ? 1.055 * Math.pow(g, 1/2.4) - 0.055 : 12.92 * g;
      bVal = bVal > 0.0031308 ? 1.055 * Math.pow(bVal, 1/2.4) - 0.055 : 12.92 * bVal;

      return {
        r: Math.round(Math.max(0, Math.min(255, r * 255))),
        g: Math.round(Math.max(0, Math.min(255, g * 255))),
        b: Math.round(Math.max(0, Math.min(255, bVal * 255)))
      };
    }

    function calculateDeltaE(lab1, lab2) {
      const dL = lab1.L - lab2.L;
      const da = lab1.a - lab2.a;
      const db = lab1.b - lab2.b;
      return Math.sqrt(dL * dL + da * da + db * db);
    }

    function getDeltaEInterpretation(deltaE) {
      if (deltaE < 1) return 'Not perceptible by human eyes';
      if (deltaE < 2) return 'Perceptible through close observation';
      if (deltaE < 3.5) return 'Perceptible at a glance';
      if (deltaE < 5) return 'Obvious difference';
      return 'Very obvious difference';
    }

    // Main application state
    let originalImageData = null;
    let originalImage = null;

    // DOM Elements
    const imageInput = document.getElementById('image-input');
    const canvasOriginal = document.getElementById('canvas-original');
    const canvasProcessed = document.getElementById('canvas-processed');
    const ctxOriginal = canvasOriginal.getContext('2d');
    const ctxProcessed = canvasProcessed.getContext('2d');

    const deltaLSlider = document.getElementById('deltaL');
    const deltaaSlider = document.getElementById('deltaa');
    const deltabSlider = document.getElementById('deltab');
    const deltaLInput = document.getElementById('deltaL-input');
    const deltaaInput = document.getElementById('deltaa-input');
    const deltabInput = document.getElementById('deltab-input');

    const btnCompare = document.getElementById('btn-compare');
    const btnZoom = document.getElementById('btn-zoom');
    const btnReset = document.getElementById('btn-reset');
    const btnExport = document.getElementById('btn-export');

    // Load image
    imageInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      document.getElementById('file-name').textContent = file.name;
      document.getElementById('file-name').classList.remove('hidden');

      const reader = new FileReader();
      reader.onload = (event) => {
        const img = new Image();
        img.onload = () => {
          originalImage = img;
          
          // Set canvas size
          canvasOriginal.width = img.width;
          canvasOriginal.height = img.height;
          canvasProcessed.width = img.width;
          canvasProcessed.height = img.height;

          // Draw original image
          ctxOriginal.drawImage(img, 0, 0);
          originalImageData = ctxOriginal.getImageData(0, 0, img.width, img.height);

          // Show canvases
          canvasOriginal.classList.remove('hidden');
          canvasProcessed.classList.remove('hidden');
          document.getElementById('placeholder-original').classList.add('hidden');
          document.getElementById('placeholder-processed').classList.add('hidden');

          // Enable buttons
          btnCompare.disabled = false;
          btnZoom.disabled = false;
          btnExport.disabled = false;

          // Process image
          processImage();
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    // Sync sliders and inputs
    function syncSliderToInput(slider, input, valueDisplay) {
      slider.addEventListener('input', () => {
        const val = parseFloat(slider.value).toFixed(2);
        input.value = val;
        valueDisplay.textContent = val;
        processImage();
      });

      input.addEventListener('input', () => {
        let val = parseFloat(input.value) || 0;
        val = Math.max(-50, Math.min(50, val));
        slider.value = val;
        valueDisplay.textContent = val.toFixed(2);
        processImage();
      });
    }

    syncSliderToInput(deltaLSlider, deltaLInput, document.getElementById('deltaL-value'));
    syncSliderToInput(deltaaSlider, deltaaInput, document.getElementById('deltaa-value'));
    syncSliderToInput(deltabSlider, deltabInput, document.getElementById('deltab-value'));

    // Process image with delta values
    let processingTimeout = null;
    function processImage() {
      if (!originalImageData) return;

      // Debounce processing
      if (processingTimeout) clearTimeout(processingTimeout);
      processingTimeout = setTimeout(() => {
        doProcessImage();
      }, 50);
    }

    function doProcessImage() {
      if (!originalImageData) return;

      const deltaL = parseFloat(deltaLSlider.value);
      const deltaa = parseFloat(deltaaSlider.value);
      const deltab = parseFloat(deltabSlider.value);

      const srcData = originalImageData.data;
      const destImageData = ctxProcessed.createImageData(originalImageData.width, originalImageData.height);
      const destData = destImageData.data;

      let sumOrigL = 0, sumOrigA = 0, sumOrigB = 0;
      let sumProcL = 0, sumProcA = 0, sumProcB = 0;
      let pixelCount = 0;

      for (let i = 0; i < srcData.length; i += 4) {
        const r = srcData[i];
        const g = srcData[i + 1];
        const b = srcData[i + 2];
        const a = srcData[i + 3];

        // Convert to LAB
        const lab = rgbToLab(r, g, b);

        // Accumulate original LAB
        sumOrigL += lab.L;
        sumOrigA += lab.a;
        sumOrigB += lab.b;

        // Apply delta
        const newL = Math.max(0, Math.min(100, lab.L + deltaL));
        const newA = Math.max(-128, Math.min(128, lab.a + deltaa));
        const newB = Math.max(-128, Math.min(128, lab.b + deltab));

        // Accumulate processed LAB
        sumProcL += newL;
        sumProcA += newA;
        sumProcB += newB;

        // Convert back to RGB
        const rgb = labToRgb(newL, newA, newB);

        destData[i] = rgb.r;
        destData[i + 1] = rgb.g;
        destData[i + 2] = rgb.b;
        destData[i + 3] = a;

        pixelCount++;
      }

      ctxProcessed.putImageData(destImageData, 0, 0);

      // Update statistics
      const avgOrigL = sumOrigL / pixelCount;
      const avgOrigA = sumOrigA / pixelCount;
      const avgOrigB = sumOrigB / pixelCount;
      const avgProcL = sumProcL / pixelCount;
      const avgProcA = sumProcA / pixelCount;
      const avgProcB = sumProcB / pixelCount;

      document.getElementById('stat-orig-L').textContent = avgOrigL.toFixed(2);
      document.getElementById('stat-orig-a').textContent = avgOrigA.toFixed(2);
      document.getElementById('stat-orig-b').textContent = avgOrigB.toFixed(2);
      document.getElementById('stat-proc-L').textContent = avgProcL.toFixed(2);
      document.getElementById('stat-proc-a').textContent = avgProcA.toFixed(2);
      document.getElementById('stat-proc-b').textContent = avgProcB.toFixed(2);

      const deltaE = calculateDeltaE(
        { L: avgOrigL, a: avgOrigA, b: avgOrigB },
        { L: avgProcL, a: avgProcA, b: avgProcB }
      );
      document.getElementById('stat-deltaE').textContent = deltaE.toFixed(2);
      document.getElementById('deltaE-interpretation').textContent = getDeltaEInterpretation(deltaE);
    }

    // Reset button
    btnReset.addEventListener('click', () => {
      deltaLSlider.value = 0;
      deltaaSlider.value = 0;
      deltabSlider.value = 0;
      deltaLInput.value = 0;
      deltaaInput.value = 0;
      deltabInput.value = 0;
      document.getElementById('deltaL-value').textContent = '0.00';
      document.getElementById('deltaa-value').textContent = '0.00';
      document.getElementById('deltab-value').textContent = '0.00';
      processImage();
    });

    // Export button
    btnExport.addEventListener('click', () => {
      if (!originalImage) return;
      
      const link = document.createElement('a');
      link.download = 'simulated-dyed-fabric.png';
      link.href = canvasProcessed.toDataURL('image/png');
      link.click();
    });

    // Compare functionality
    const compareContainer = document.getElementById('compare-container');
    const canvasCompareBefore = document.getElementById('canvas-compare-before');
    const canvasCompareAfter = document.getElementById('canvas-compare-after');
    const compareSlider = document.getElementById('compare-slider');

    btnCompare.addEventListener('click', () => {
      if (!originalImage) return;

      document.getElementById('canvas-container').classList.add('hidden');
      compareContainer.classList.remove('hidden');
      document.getElementById('zoom-container').classList.add('hidden');

      // Setup compare canvases
      const container = compareContainer.querySelector('.relative');
      const containerWidth = container.offsetWidth;
      const containerHeight = container.offsetHeight;
      const imgRatio = originalImage.width / originalImage.height;
      const containerRatio = containerWidth / containerHeight;

      let drawWidth, drawHeight;
      if (imgRatio > containerRatio) {
        drawWidth = containerWidth;
        drawHeight = containerWidth / imgRatio;
      } else {
        drawHeight = containerHeight;
        drawWidth = containerHeight * imgRatio;
      }

      canvasCompareBefore.width = drawWidth;
      canvasCompareBefore.height = drawHeight;
      canvasCompareAfter.width = drawWidth;
      canvasCompareAfter.height = drawHeight;

      const ctxBefore = canvasCompareBefore.getContext('2d');
      const ctxAfter = canvasCompareAfter.getContext('2d');

      ctxBefore.drawImage(canvasOriginal, 0, 0, drawWidth, drawHeight);
      ctxAfter.drawImage(canvasProcessed, 0, 0, drawWidth, drawHeight);

      // Center canvases
      const offsetX = (containerWidth - drawWidth) / 2;
      const offsetY = (containerHeight - drawHeight) / 2;
      canvasCompareBefore.style.left = offsetX + 'px';
      canvasCompareBefore.style.top = offsetY + 'px';
      canvasCompareAfter.style.left = offsetX + 'px';
      canvasCompareAfter.style.top = offsetY + 'px';

      compareSlider.style.left = '50%';
      updateCompareClip(0.5);
    });

    function updateCompareClip(ratio) {
      canvasCompareAfter.style.clipPath = `inset(0 ${(1 - ratio) * 100}% 0 0)`;
    }

    // Compare slider drag
    let isDragging = false;
    compareSlider.addEventListener('mousedown', () => isDragging = true);
    compareSlider.addEventListener('touchstart', () => isDragging = true);

    document.addEventListener('mousemove', (e) => {
      if (!isDragging) return;
      handleCompareDrag(e.clientX);
    });

    document.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      handleCompareDrag(e.touches[0].clientX);
    });

    document.addEventListener('mouseup', () => isDragging = false);
    document.addEventListener('touchend', () => isDragging = false);

    function handleCompareDrag(clientX) {
      const container = compareContainer.querySelector('.relative');
      const rect = container.getBoundingClientRect();
      let ratio = (clientX - rect.left) / rect.width;
      ratio = Math.max(0, Math.min(1, ratio));
      compareSlider.style.left = (ratio * 100) + '%';
      updateCompareClip(ratio);
    }

    document.getElementById('btn-close-compare').addEventListener('click', () => {
      compareContainer.classList.add('hidden');
      document.getElementById('canvas-container').classList.remove('hidden');
    });

    // Zoom functionality
    const zoomContainer = document.getElementById('zoom-container');
    const canvasZoom = document.getElementById('canvas-zoom');

    btnZoom.addEventListener('click', () => {
      if (!originalImage) return;

      document.getElementById('canvas-container').classList.add('hidden');
      compareContainer.classList.add('hidden');
      zoomContainer.classList.remove('hidden');

      // Draw at 100%
      canvasZoom.width = canvasProcessed.width;
      canvasZoom.height = canvasProcessed.height;
      const ctxZoom = canvasZoom.getContext('2d');
      ctxZoom.drawImage(canvasProcessed, 0, 0);
    });

    document.getElementById('btn-close-zoom').addEventListener('click', () => {
      zoomContainer.classList.add('hidden');
      document.getElementById('canvas-container').classList.remove('hidden');
    });

    // Drag to pan in zoom container
    const zoomScroll = zoomContainer.querySelector('.zoom-container');
    let isZoomDragging = false;
    let zoomStartX, zoomStartY, zoomScrollLeft, zoomScrollTop;

    zoomScroll.addEventListener('mousedown', (e) => {
      isZoomDragging = true;
      zoomStartX = e.pageX - zoomScroll.offsetLeft;
      zoomStartY = e.pageY - zoomScroll.offsetTop;
      zoomScrollLeft = zoomScroll.scrollLeft;
      zoomScrollTop = zoomScroll.scrollTop;
    });

    zoomScroll.addEventListener('mouseleave', () => isZoomDragging = false);
    zoomScroll.addEventListener('mouseup', () => isZoomDragging = false);

    zoomScroll.addEventListener('mousemove', (e) => {
      if (!isZoomDragging) return;
      e.preventDefault();
      const x = e.pageX - zoomScroll.offsetLeft;
      const y = e.pageY - zoomScroll.offsetTop;
      zoomScroll.scrollLeft = zoomScrollLeft - (x - zoomStartX);
      zoomScroll.scrollTop = zoomScrollTop - (y - zoomStartY);
    });

    // Apply initial config
    applyConfig();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c1cbe1da0e6d32c',t:'MTc2OTA2MDcwMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
